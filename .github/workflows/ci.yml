name: CI - Tests & Build

on:
  push:
    branches: [ main, develop, "claude/**" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend:
    name: Backend Tests & Lint
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: backend/go.sum

      - name: üì¶ Install dependencies
        run: make install

      - name: üß™ Run tests with coverage
        run: make test-coverage

      - name: üé® Lint backend
        run: make lint-backend

      - name: üî® Build backend
        run: make build-backend

      - name: üì§ Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.out
          retention-days: 7

  frontend:
    name: Frontend Lint & Build
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: üì¶ Install dependencies
        run: cd frontend && npm ci

      - name: üé® Lint frontend
        run: make lint-frontend

      - name: üî® Build frontend
        run: make build-frontend

      - name: üì§ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: always()

    steps:
      - name: üìä Generate summary
        run: |
          echo "## üß™ CI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.backend.result }}" == "success" ]; then
            echo "‚úÖ Backend: **PASSED** (tests + lint + build)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Backend: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.frontend.result }}" == "success" ]; then
            echo "‚úÖ Frontend: **PASSED** (lint + build)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Frontend: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Coverage**: 65.2% (38 backend tests)" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Workflow**: [\`${{ github.workflow }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Fail if any job failed
        if: needs.backend.result != 'success' || needs.frontend.result != 'success'
        run: exit 1
