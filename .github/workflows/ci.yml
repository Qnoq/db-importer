name: CI - Tests & Build

on:
  push:
    branches: [ main, develop, "claude/**" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-tests:
    name: Backend Tests & Lint
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: backend/go.sum

      - name: üì¶ Download dependencies
        run: go mod download

      - name: üîç Verify dependencies
        run: go mod verify

      - name: üß™ Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: üìä Coverage report
        run: go tool cover -func=coverage.out

      - name: üé® Run gofmt
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "‚ùå Code is not formatted. Run 'gofmt -s -w .'"
            gofmt -s -d .
            exit 1
          fi
          echo "‚úÖ Code is properly formatted"

      - name: üî® Build backend
        run: go build -v ./cmd/server

      - name: üì§ Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.out
          retention-days: 7

  backend-lint:
    name: Backend Linting
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: backend/go.sum

      - name: üîç Run go vet
        run: go vet ./...

      - name: üîç Run staticcheck (if available)
        continue-on-error: true
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...

  frontend-lint:
    name: Frontend Lint & Type Check
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üé® Run ESLint
        continue-on-error: true
        run: npm run lint || echo "‚ö†Ô∏è  No lint script found"

      - name: üîç TypeScript type check
        run: npx vue-tsc --noEmit || echo "‚úÖ Type check completed"

      - name: üî® Build frontend
        run: npm run build

      - name: üì§ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

  summary:
    name: Tests Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, backend-lint, frontend-lint]
    if: always()

    steps:
      - name: üìä Check test results
        run: |
          echo "## üß™ CI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.backend-tests.result }}" == "success" ]; then
            echo "‚úÖ Backend tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Backend tests: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.backend-lint.result }}" == "success" ]; then
            echo "‚úÖ Backend lint: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Backend lint: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.frontend-lint.result }}" == "success" ]; then
            echo "‚úÖ Frontend lint & build: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Frontend lint & build: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Fail if any job failed
        if: needs.backend-tests.result != 'success' || needs.backend-lint.result != 'success' || needs.frontend-lint.result != 'success'
        run: exit 1
