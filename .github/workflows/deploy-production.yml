name: Deploy to Production VPS

# Manual deployment only: click "Run workflow" button in GitHub Actions tab
# This gives you full control over when to deploy to production
on:
  workflow_dispatch:  # Manual trigger only from GitHub UI

jobs:
  deploy:
    name: Deploy to Hostinger VPS
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â“ Validate Deployment Secrets
        run: |
          echo "Checking required secrets..."
          if [[ -z "${{ secrets.DEPLOY_KEY }}" ]]; then
            echo "âŒ DEPLOY_KEY secret is not set!"
            exit 1
          fi
          if [[ -z "${{ vars.HOSTINGER_VM_ID }}" ]]; then
            echo "âŒ HOSTINGER_VM_ID variable is not set!"
            exit 1
          fi
          echo "âœ… All deployment secrets are configured"
          echo "Deploying to VM ID: ${{ vars.HOSTINGER_VM_ID }}"

      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Hostinger VM hostname format
          SSH_HOST="srv${{ vars.HOSTINGER_VM_ID }}.hstgr.cloud"
          echo "SSH_HOST=$SSH_HOST" >> $GITHUB_ENV
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to Hostinger VPS
        env:
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH || '/docker/db-importer' }}
        run: |
          ssh -o StrictHostKeyChecking=no root@$SSH_HOST << 'ENDSSH'
            set -e

            echo "ðŸ“ Navigating to deployment directory..."
            cd ${{ vars.DEPLOY_PATH || '/docker/db-importer' }}

            echo "ðŸ“¦ Pulling latest code from GitHub..."
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            echo "ðŸ›‘ Stopping existing containers..."
            docker compose down

            echo "ðŸ—ï¸  Building new images..."
            docker compose build --no-cache

            echo "ðŸš€ Starting containers..."
            docker compose up -d

            echo "â³ Waiting for services to be healthy..."
            sleep 10

            echo "ðŸ“Š Checking container status..."
            docker compose ps

            echo "ðŸ“ Showing recent logs..."
            docker compose logs --tail=50

            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: ðŸ§¹ Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa

      - name: âœ… Deployment Complete
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Application is now live on your VPS"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âš ï¸ Deployment failed. Check the logs above."
          exit 1
