name: Deploy to Production VPS

# Manual deployment only: click "Run workflow" button in GitHub Actions tab
# This gives you full control over when to deploy to production
on:
  workflow_dispatch:  # Manual trigger only from GitHub UI

jobs:
  deploy:
    name: Deploy to Hostinger VPS
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â“ Validate SSH Secrets
        run: |
          echo "Checking required secrets..."
          if [[ -z "${{ secrets.SSH_HOST }}" ]]; then
            echo "âŒ SSH_HOST secret is not set!"
            echo "Please add it in: Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            exit 1
          fi
          if [[ -z "${{ secrets.SSH_USER }}" ]]; then
            echo "âŒ SSH_USER secret is not set!"
            exit 1
          fi
          if [[ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]]; then
            echo "âŒ SSH_PRIVATE_KEY secret is not set!"
            exit 1
          fi
          echo "âœ… All SSH secrets are configured"

      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to Hostinger VPS
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH || '/docker/db-importer' }}
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e

            echo "ðŸ“ Navigating to deployment directory..."
            cd ${{ vars.DEPLOY_PATH || '/docker/db-importer' }}

            echo "ðŸ“¦ Pulling latest code from GitHub..."
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            echo "ðŸ›‘ Stopping existing containers..."
            docker compose down

            echo "ðŸ—ï¸  Building new images..."
            docker compose build --no-cache

            echo "ðŸš€ Starting containers..."
            docker compose up -d

            echo "â³ Waiting for services to be healthy..."
            sleep 10

            echo "ðŸ“Š Checking container status..."
            docker compose ps

            echo "ðŸ“ Showing recent logs..."
            docker compose logs --tail=50

            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: ðŸ§¹ Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa

      - name: âœ… Deployment Complete
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Application is now live on your VPS"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âš ï¸ Deployment failed. Check the logs above."
          exit 1
