name: Deploy to Production VPS

# Manual deployment only: click "Run workflow" button in GitHub Actions tab
# This gives you full control over when to deploy to production
on:
  workflow_dispatch:  # Manual trigger only from GitHub UI

jobs:
  deploy:
    name: Deploy to Hostinger VPS
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üöÄ Deploy to Hostinger VPS
        uses: hostinger/deploy-on-vps@v2
        with:
          api-key: ${{ secrets.HOSTINGER_API_KEY }}
          virtual-machine: ${{ vars.HOSTINGER_VM_ID }}
          docker-compose-path: docker-compose.yml
          environment-variables: |
            PORT=${{ vars.PORT || '8080' }}
            ALLOWED_ORIGINS=${{ vars.ALLOWED_ORIGINS }}
            VITE_API_URL=${{ vars.VITE_API_URL }}
            MAX_UPLOAD_SIZE=${{ vars.MAX_UPLOAD_SIZE || '52428800' }}
            DEBUG_LOG=${{ vars.DEBUG_LOG || 'false' }}
            RATE_LIMIT_ENABLED=${{ vars.RATE_LIMIT_ENABLED || 'true' }}
            RATE_LIMIT_REQUESTS=${{ vars.RATE_LIMIT_REQUESTS || '50' }}
            RATE_LIMIT_WINDOW=${{ vars.RATE_LIMIT_WINDOW || '60' }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            DB_MAX_OPEN_CONNS=${{ vars.DB_MAX_OPEN_CONNS || '25' }}
            DB_MAX_IDLE_CONNS=${{ vars.DB_MAX_IDLE_CONNS || '5' }}
            DB_CONN_MAX_LIFETIME=${{ vars.DB_CONN_MAX_LIFETIME || '5m' }}
            DB_CONN_MAX_IDLE_TIME=${{ vars.DB_CONN_MAX_IDLE_TIME || '10m' }}
            JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            JWT_ACCESS_EXPIRY=${{ vars.JWT_ACCESS_EXPIRY || '15m' }}
            JWT_REFRESH_EXPIRY=${{ vars.JWT_REFRESH_EXPIRY || '168h' }}
            SUPABASE_URL=${{ vars.SUPABASE_URL }}
            SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
            SUPABASE_PROJECT_REF=${{ vars.SUPABASE_PROJECT_REF }}

      - name: ‚úÖ Deployment Complete
        if: success()
        run: |
          echo "üéâ Deployment successful!"
          echo "Application is now live on your VPS"

      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "‚ö†Ô∏è Deployment failed. Check the logs above."
          exit 1
